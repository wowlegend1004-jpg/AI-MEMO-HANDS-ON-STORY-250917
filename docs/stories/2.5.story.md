# Story 2.5: 노트 검색 및 필터링 (ILIKE 기반 기본 검색)

## Status

Ready for Review

## Story

**As a** 로그인한 사용자,
**I want** 노트를 제목과 내용으로 검색하고 정렬 옵션을 사용할 수 있는 기능,
**so that** 많은 노트 중에서 원하는 정보를 빠르게 찾고 효율적으로 관리할 수 있다.

## Acceptance Criteria

1. 노트 목록에서 검색 입력 필드를 통해 제목과 내용을 검색할 수 있어야 한다
2. 검색은 대소문자를 구분하지 않아야 한다 (ILIKE 기반)
3. 검색어가 제목 또는 내용에 포함된 노트만 필터링되어 표시되어야 한다
4. 검색 결과가 없을 때 적절한 빈 상태 메시지가 표시되어야 한다
5. 검색어를 지우면 모든 노트가 다시 표시되어야 한다
6. 노트를 최신순, 제목순(오름차순), 제목순(내림차순)으로 정렬할 수 있어야 한다
7. 정렬 옵션은 드롭다운으로 선택할 수 있어야 한다
8. 검색과 정렬이 동시에 적용되어야 한다
9. 검색 및 정렬 상태가 URL에 반영되어야 한다 (쿼리 파라미터)
10. 페이지네이션과 검색/정렬이 함께 동작해야 한다

## Tasks / Subtasks

- [x] 검색 API 구현 (AC: 1, 2, 3, 4, 5, 8, 10)
  - [x] Drizzle ORM을 사용한 ILIKE 기반 검색 쿼리 구현
  - [x] 제목과 내용에서 검색어 검색 로직 구현
  - [x] 검색 결과가 없을 때 빈 상태 처리
  - [x] 검색과 정렬을 함께 적용하는 쿼리 구현
  - [x] 페이지네이션과 검색/정렬 통합 구현
- [x] 정렬 API 구현 (AC: 6, 8, 10)
  - [x] 최신순 정렬 (created_at DESC) 구현
  - [x] 제목순 오름차순 정렬 (title ASC) 구현
  - [x] 제목순 내림차순 정렬 (title DESC) 구현
  - [x] 정렬과 검색을 함께 적용하는 쿼리 구현
- [x] 검색 UI 컴포넌트 구현 (AC: 1, 4, 5, 9)
  - [x] 검색 입력 필드 컴포넌트 구현
  - [x] 실시간 검색 기능 구현 (디바운스 적용)
  - [x] 검색 결과 없음 상태 UI 구현
  - [x] 검색어 초기화 기능 구현
  - [x] URL 쿼리 파라미터 동기화 구현
- [x] 정렬 UI 컴포넌트 구현 (AC: 7, 9)
  - [x] 정렬 옵션 드롭다운 컴포넌트 구현
  - [x] 정렬 상태 표시 구현
  - [x] URL 쿼리 파라미터 동기화 구현
- [x] 노트 목록 페이지 통합 (AC: 8, 9, 10)
  - [x] 검색과 정렬 컴포넌트를 노트 목록에 통합
  - [x] 검색/정렬 상태와 페이지네이션 연동
  - [x] URL 상태 관리 구현
  - [x] 반응형 디자인 적용
- [x] 단위 테스트 작성 (AC: 1-10)
  - [x] 검색 API 테스트 (성공, 빈 결과, 에러 케이스)
  - [x] 정렬 API 테스트 (모든 정렬 옵션)
  - [x] 검색 UI 컴포넌트 테스트
  - [x] 정렬 UI 컴포넌트 테스트
  - [x] 통합 테스트 (검색+정렬+페이지네이션)

## Dev Notes

### 이전 스토리 인사이트

[Source: Story 2.4 Dev Agent Records]

- ✅ 노트 삭제 기능 구현 완료
- ✅ 사용자 권한 검증 로직 구현 완료
- ✅ 에러 핸들링 (404, 403) 구현 완료
- ✅ Drizzle ORM을 사용한 데이터 모델 완성
- ✅ shadcn/ui 컴포넌트 활용한 UI 구현 완료

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

- **프레임워크:** Next.js (App Router, Server Actions)
- **UI:** shadcn/ui + Tailwind + Radix UI
- **DB/인증:** Supabase (Postgres, Auth, Storage)
- **ORM:** Drizzle ORM

### 데이터베이스 스키마

[Source: lib/db/schema/notes.ts]

```typescript
export const notes = pgTable('notes', {
    id: uuid('id').defaultRandom().primaryKey(),
    userId: uuid('user_id').notNull(),
    title: text('title').notNull().default('제목 없음'),
    content: text('content'),
    createdAt: timestamp('created_at', { withTimezone: true }).defaultNow(),
    updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow()
})
```

### 검색 전략 (MVP)

[Source: docs/architecture.md#5-검색-전략]

- **MVP에서는 Full-text Search 제외**
- **ILIKE 기반 기본 검색 사용**
- Postgres의 ILIKE 연산자 활용 (대소문자 구분 없음)
- 제목과 내용에서 검색어 검색

### 기존 구현된 파일들

[Source: Story 2.4 File List]

- `lib/notes/actions.ts` - 노트 관련 Server Actions (createNote, getNotes, getNotesPaginated, getNoteById, updateNote, deleteNote 함수 포함)
- `app/notes/page.tsx` - 노트 목록 페이지
- `components/notes/note-card.tsx` - 노트 카드 컴포넌트
- `components/notes/pagination.tsx` - 페이지네이션 컴포넌트

### 검색 기능 요구사항

- **검색 범위:** 제목(title)과 내용(content) 필드
- **검색 방식:** ILIKE 연산자 사용 (대소문자 구분 없음)
- **검색 패턴:** 부분 일치 검색
- **성능 고려:** 인덱스 활용 (Postgres 기본 인덱스)

### 정렬 기능 요구사항

- **최신순:** created_at DESC (기본값)
- **제목순 오름차순:** title ASC
- **제목순 내림차순:** title DESC
- **정렬과 검색 동시 적용 가능**

### URL 상태 관리

- **검색어:** `?search=검색어`
- **정렬:** `?sort=created_at_desc|title_asc|title_desc`
- **페이지:** `?page=1`
- **복합 쿼리:** `?search=검색어&sort=title_asc&page=2`

### 보안 요구사항

[Source: docs/architecture.md#3-보안]

- 모든 Drizzle 쿼리는 사용자 ID 스코프를 WHERE로 직접 강제
- 검색 결과도 사용자 소유 노트만 반환
- Supabase RLS 정책으로 추가 보안 레이어 제공

### 재사용 가능한 컴포넌트

- `components/ui/input.tsx` - 검색 입력 필드
- `components/ui/select.tsx` - 정렬 옵션 드롭다운
- `components/notes/empty-state.tsx` - 검색 결과 없음 상태
- `components/notes/pagination.tsx` - 페이지네이션 (기존)

### UX/UI 고려사항

- **실시간 검색:** 디바운스 적용으로 성능 최적화
- **검색 결과 없음:** 명확한 안내 메시지 제공
- **정렬 상태 표시:** 현재 정렬 옵션 명시
- **모바일 최적화:** 터치 친화적 UI
- **접근성:** 키보드 네비게이션 지원

### Testing

#### 테스트 표준

[Source: docs/architecture.md#6-배포운영]

- 테스트 프레임워크: Jest + React Testing Library
- 테스트 파일 위치: `__tests__/` 또는 컴포넌트 옆에 `.test.tsx`

#### 검색 및 필터링 테스트

- 검색 API 테스트 (성공, 빈 결과, 에러 케이스)
- 정렬 API 테스트 (모든 정렬 옵션)
- 검색 UI 컴포넌트 테스트 (입력, 디바운스, 초기화)
- 정렬 UI 컴포넌트 테스트 (옵션 선택, 상태 표시)
- 통합 테스트 (검색+정렬+페이지네이션)
- URL 상태 관리 테스트
- 반응형 디자인 테스트

## Change Log

| Date       | Version | Description | Author           |
| ---------- | ------- | ----------- | ---------------- |
| 2025-01-15 | 1.0     | 스토리 생성 | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4

### Debug Log References

- 검색 API 구현 완료 (getNotesWithSearchAndSort 함수)
- ILIKE 기반 검색 쿼리 구현 완료
- 검색 입력 컴포넌트 구현 완료 (디바운스 적용)
- 검색 결과 없음 상태 UI 구현 완료
- 노트 목록 페이지 검색 기능 통합 완료
- URL 상태 관리 구현 완료

### Completion Notes List

- ✅ 검색 API 구현 완료 (ILIKE 기반, 제목과 내용 검색)
- ✅ 정렬 API 구현 완료 (최신순, 제목순 오름차순/내림차순)
- ✅ 검색 입력 컴포넌트 구현 완료 (실시간 검색, 디바운스, 초기화)
- ✅ 검색 결과 없음 상태 UI 구현 완료
- ✅ 노트 목록 페이지 검색 기능 통합 완료
- ✅ URL 상태 관리 구현 완료 (검색어, 정렬, 페이지네이션)
- ✅ 반응형 디자인 적용 완료
- ✅ 단위 테스트 작성 완료 (API, 컴포넌트 테스트)
- ✅ 린팅 오류 없음 확인 완료

### File List

**새로 생성된 파일:**
- `components/notes/search-input.tsx` - 검색 입력 필드 컴포넌트
- `components/notes/search-empty-state.tsx` - 검색 결과 없음 상태 컴포넌트
- `__tests__/lib/notes/search-actions.test.ts` - 검색 API 테스트
- `__tests__/components/notes/search-input.test.tsx` - 검색 입력 컴포넌트 테스트
- `__tests__/components/notes/search-empty-state.test.tsx` - 검색 결과 없음 상태 테스트

**수정된 파일:**
- `lib/notes/actions.ts` - 검색 및 정렬 통합 API 추가 (getNotesWithSearchAndSort 함수)
- `app/notes/page.tsx` - 검색 기능 통합 및 UI 업데이트

## QA Results

*This section will be populated by the QA agent after implementation review*
