# Story 1.3: 비밀번호 재설정 & 로그아웃 기능

## Status

Done

## Story

**As a** 등록된 사용자,
**I want** 비밀번호를 재설정하고 안전하게 로그아웃할 수 있는 기능,
**so that** 계정 보안을 유지하고 필요 시 세션을 안전하게 종료할 수 있다.

## Acceptance Criteria

### 비밀번호 재설정

1. 기존 비밀번호 찾기 페이지에서 이메일 입력 및 재설정 링크 발송이 가능해야 한다
2. 이메일로 발송된 재설정 링크 클릭 시 새 비밀번호 설정 페이지로 이동해야 한다
3. 새 비밀번호 설정 시 비밀번호 강도 검증과 확인이 이루어져야 한다
4. 비밀번호 재설정 완료 후 로그인 페이지로 리다이렉트되어야 한다
5. 비밀번호 재설정 과정의 모든 에러는 사용자 친화적 메시지로 표시되어야 한다

### 로그아웃 기능

6. 메인 페이지(대시보드)에 로그아웃 버튼이 제공되어야 한다
7. 로그아웃 클릭 시 확인 다이얼로그가 표시되어야 한다
8. 로그아웃 완료 후 모든 세션이 종료되고 로그인 페이지로 리다이렉트되어야 한다
9. 로그아웃 후 브라우저 뒤로가기로 보호된 페이지 접근이 불가능해야 한다

## Tasks / Subtasks

-   [x] 비밀번호 재설정 기능 구현 (AC: 1, 2, 3, 4, 5)
    -   [x] 기존 비밀번호 찾기 페이지 기능 완성
    -   [x] 비밀번호 재설정 이메일 발송 서버 액션 구현
    -   [x] 비밀번호 재설정 페이지 구현 (`/auth/reset-password`)
    -   [x] 새 비밀번호 설정 폼 컴포넌트 구현
    -   [x] 비밀번호 강도 검증 및 확인 로직
    -   [x] 재설정 완료 후 로그인 페이지 리다이렉트
    -   [x] 에러 핸들링 및 사용자 친화적 메시지
-   [x] 로그아웃 기능 구현 (AC: 6, 7, 8, 9)
    -   [x] 메인 페이지 로그아웃 버튼 기능 연결
    -   [x] 로그아웃 확인 다이얼로그 컴포넌트 구현
    -   [x] 로그아웃 서버 액션 구현
    -   [x] 세션 종료 및 로그인 페이지 리다이렉트
    -   [x] 로그아웃 후 보호된 페이지 접근 방지 확인

## Dev Notes

### 이전 스토리 인사이트

[Source: Story 1.1, 1.2 Dev Agent Records]

-   ✅ Supabase Auth 인프라 완전 구축 완료
-   ✅ 서버 액션 패턴 (`lib/auth/actions.ts`) 확립
-   ✅ shadcn/ui 컴포넌트 시스템 일관성 확보
-   ✅ 실시간 폼 유효성 검사 패턴 정립
-   ✅ 에러 핸들링 및 사용자 친화적 메시지 표준화
-   ✅ 임시 비밀번호 찾기 페이지 이미 존재 (`app/auth/forgot-password/page.tsx`)

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

-   **프레임워크:** Next.js (App Router, Server Actions)
-   **UI:** shadcn/ui + Tailwind + Radix UI
-   **DB/인증:** Supabase (Postgres, Auth, Storage)

### 보안 요구사항

[Source: docs/architecture.md#3-보안]

-   Supabase 서비스 롤 키는 서버 전용으로 사용
-   사용자 ID 스코프로 권한 제어

### 프로젝트 구조

**비밀번고 재설정**:

-   기존 페이지 개선: `app/auth/forgot-password/page.tsx`
-   새 재설정 페이지: `app/auth/reset-password/page.tsx`
-   재설정 폼 컴포넌트: `components/auth/reset-password-form.tsx`
-   서버 액션 추가: `lib/auth/actions.ts` (resetPassword, updatePassword)

**로그아웃 기능**:

-   메인 페이지 수정: `app/page.tsx` (로그아웃 버튼 기능 연결)
-   로그아웃 다이얼로그: `components/auth/logout-dialog.tsx`
-   서버 액션 추가: `lib/auth/actions.ts` (signOut)

### Supabase Auth 구성

**비밀번호 재설정**:

-   `supabase.auth.resetPasswordForEmail()` 사용
-   이메일 템플릿 설정 확인 필요
-   재설정 토큰 검증 및 새 비밀번호 업데이트

**로그아웃**:

-   `supabase.auth.signOut()` 사용
-   클라이언트 및 서버 세션 모두 정리
-   쿠키 및 로컬 스토리지 정리

### 환경 변수 요구사항

[Source: Story 1.1, 1.2 - 이미 설정 완료]

-   ✅ `NEXT_PUBLIC_SUPABASE_URL`
-   ✅ `NEXT_PUBLIC_SUPABASE_ANON_KEY`
-   ✅ `SUPABASE_SERVICE_ROLE_KEY`
-   ✅ `NEXT_PUBLIC_SITE_URL`

### 재사용 가능한 컴포넌트

-   `components/ui/button.tsx` - 로그아웃 버튼, 재설정 버튼
-   `components/ui/input.tsx` - 새 비밀번호 입력
-   `components/ui/label.tsx` - 폼 레이블
-   `components/ui/card.tsx` - 재설정 폼 컨테이너
-   `components/ui/dialog.tsx` - 로그아웃 확인 다이얼로그

### Testing

#### 테스트 표준

[Source: docs/architecture.md#6-배포운영]

-   테스트 프레임워크: Jest + React Testing Library (추정)
-   테스트 파일 위치: `__tests__/` 또는 컴포넌트 옆에 `.test.tsx`
-   단위 테스트와 통합 테스트 모두 구현
-   Supabase Auth 목킹 필요

#### 주요 테스트 시나리오

**비밀번호 재설정**:

-   유효한 이메일로 재설정 링크 요청
-   유효하지 않은 이메일 처리
-   재설정 토큰 검증
-   새 비밀번호 강도 검증
-   비밀번호 확인 일치 검증

**로그아웃**:

-   로그아웃 확인 다이얼로그 동작
-   로그아웃 후 세션 종료 확인
-   로그아웃 후 보호된 페이지 접근 차단

## Change Log

| Date       | Version | Description                                                                                        | Author           |
| ---------- | ------- | -------------------------------------------------------------------------------------------------- | ---------------- |
| 2025-09-13 | 1.0     | 통합 스토리 생성                                                                                   | Scrum Master Bob |
| 2025-09-13 | 2.0     | 스토리 구현 완료                                                                                   | Developer Agent  |
| 2025-09-13 | 2.1     | reset-password에서 "로그인 페이지로 돌아가기" 시 로그아웃 처리, auth/callback의 recovery 분기 제거 | Developer Agent  |

## Dev Agent Record

이 섹션은 개발 에이전트가 구현 중에 채워집니다.

### Agent Model Used

Claude 3.5 Sonnet (Developer Agent)

### Debug Log References

-   Terminal logs: `otp_expired` 에러 및 Next.js 15 `searchParams` 비동기 처리 경고
-   Supabase Auth 보안 경고: `getSession()` vs `getUser()` 사용
-   재설정 페이지에서 로그인으로 복귀 시 대시보드로 리다이렉트되는 이슈 재현 및 수정 내역

### Completion Notes List

1. ✅ **비밀번호 재설정 플로우 구현**

    - 이메일 요청: `/auth/forgot-password`
    - 링크 콜백 처리: `/auth/callback`
    - 비밀번호 변경: `/auth/reset-password`

2. ✅ **로그아웃 기능 구현**

    - 로그아웃 다이얼로그 컴포넌트
    - 서버 액션을 통한 안전한 로그아웃
    - 대시보드 통합

3. ✅ **토큰 처리 로직 개선**

    - URL fragment에서 access_token 올바른 감지
    - 클라이언트 사이드 세션 확인
    - 만료된 링크 에러 처리

4. ✅ **Next.js 15 호환성 개선**

    - `searchParams` 비동기 처리 적용
    - Supabase Auth `getUser()` 사용으로 보안 강화

5. ✅ **UX/흐름 안정화**
    - reset-password 페이지의 "로그인 페이지로 돌아가기" 클릭 시 `signOut()`을 호출하여 세션 종료 후 `/signin`으로 이동하도록 변경
    - `app/auth/callback/route.ts`에서 `type=recovery` 분기를 제거하여 역할을 회원가입 인증 콜백으로 명확화

### File List

**새로 생성된 파일:**

-   `components/auth/logout-dialog.tsx` - 로그아웃 확인 다이얼로그
-   `app/auth/forgot-password/page.tsx` - 비밀번호 재설정 요청 페이지
-   `app/auth/reset-password/page.tsx` - 새 비밀번호 설정 페이지

**수정된 파일:**

-   `lib/auth/actions.ts` - signOut, resetPasswordForEmail, updatePassword 액션 추가
-   `app/page.tsx` - LogoutDialog 통합, getUser() 사용
-   `app/signin/page.tsx` - 비동기 searchParams 처리, 성공 메시지 표시
-   `app/signup/page.tsx` - getUser() 사용으로 보안 강화
-   `app/auth/callback/route.ts` - 비밀번호 재설정 타입 감지 및 리다이렉트
-   `components/ui/dialog.tsx` - shadcn/ui 다이얼로그 컴포넌트 설치

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
