# Story 4.2: 노트 내용 기반 자동 요약 생성

## Status

Ready for Review

## Story

**As a** 사용자,
**I want** 노트 내용을 기반으로 AI가 자동으로 3-6개 불릿 포인트로 구성된 요약을 생성하는 기능,
**so that** 긴 노트의 핵심 내용을 빠르게 파악할 수 있다.

## Acceptance Criteria

1. 노트 내용이 100자 이상일 때만 요약 생성이 가능해야 한다
2. 요약은 3-6개의 불릿 포인트로 구성되어야 한다
3. 각 불릿 포인트는 20-50자 내외로 간결해야 한다
4. 요약 생성 시 로딩 상태가 표시되어야 한다
5. 요약 생성이 완료되면 노트 상세 페이지에 표시되어야 한다
6. 요약 생성 실패 시 적절한 에러 메시지가 표시되어야 한다
7. 요약 생성 시간이 10초를 초과하면 타임아웃 처리가 되어야 한다
8. 동일한 노트에 대해 중복 요약 생성을 방지해야 한다
9. 요약은 노트 수정 시 자동으로 재생성되어야 한다
10. 요약 생성 이력이 데이터베이스에 저장되어야 한다

## Tasks / Subtasks

- [x] 요약 생성 서버 액션 구현 (AC: 1, 4, 6, 7, 8)
  - [x] 노트 내용 길이 검증 함수 구현
  - [x] Gemini API를 통한 요약 생성 함수 구현
  - [x] 요약 생성 상태 관리 (로딩, 성공, 실패)
  - [x] 중복 요약 생성 방지 로직 구현
  - [x] 타임아웃 처리 및 에러 핸들링
- [x] 데이터베이스 스키마 확장 (AC: 10)
  - [x] summaries 테이블 스키마 정의
  - [x] 요약 생성 이력 저장 로직 구현
  - [x] 요약 데이터 조회 함수 구현
- [x] UI 컴포넌트 구현 (AC: 2, 3, 5)
  - [x] 요약 표시 컴포넌트 구현
  - [x] 요약 생성 버튼 및 로딩 상태 표시
  - [x] 요약 불릿 포인트 스타일링
  - [x] 노트 상세 페이지에 요약 섹션 통합
- [x] 요약 재생성 기능 (AC: 9)
  - [x] 노트 수정 시 요약 무효화 로직
  - [x] 수동 요약 재생성 버튼 구현
  - [x] 기존 요약 데이터 업데이트 처리
- [x] 테스트 구현
  - [x] 요약 생성 서버 액션 단위 테스트
  - [x] 요약 UI 컴포넌트 테스트
  - [x] 요약 생성 통합 테스트
  - [x] 에러 케이스 테스트

## Dev Notes

### 이전 스토리 인사이트

[Source: docs/stories/4.1.story.md#completion-notes-list]

- ✅ Gemini API 클라이언트가 완전히 구현되어 있음
- ✅ 환경변수 설정 및 에러 처리가 완료됨
- ✅ 토큰 사용량 추적 시스템이 구축됨
- ✅ 서버 액션을 통한 안전한 API 호출 구조가 마련됨

### 데이터 모델

[Source: docs/architecture.md#2-데이터-모델]

**summaries 테이블 스키마:**
```sql
CREATE TABLE summaries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  note_id UUID NOT NULL REFERENCES notes(id) ON DELETE CASCADE,
  model VARCHAR(50) NOT NULL, -- 'gemini-2.0-flash-001'
  content TEXT NOT NULL, -- 요약 내용 (불릿 포인트)
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_summaries_note_id ON summaries(note_id);
CREATE INDEX idx_summaries_created_at ON summaries(created_at);
```

**Drizzle 스키마 정의:**
```typescript
// drizzle/schema/summaries.ts
export const summaries = pgTable('summaries', {
  id: uuid('id').primaryKey().defaultRandom(),
  noteId: uuid('note_id').notNull().references(() => notes.id, { onDelete: 'cascade' }),
  model: varchar('model', { length: 50 }).notNull(),
  content: text('content').notNull(),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow()
});
```

### API 명세

[Source: docs/architecture.md#4-서버-액션]

**요약 생성 서버 액션:**
```typescript
// lib/ai/actions.ts
export async function generateSummary(noteId: string): Promise<SummaryResult> {
  // 1. 노트 내용 조회 및 검증
  // 2. 기존 요약 존재 여부 확인
  // 3. Gemini API 호출하여 요약 생성
  // 4. 요약 데이터베이스 저장
  // 5. 결과 반환
}

export async function getSummary(noteId: string): Promise<Summary | null> {
  // 노트의 최신 요약 조회
}
```

### 컴포넌트 명세

[Source: docs/architecture.md#1-기술-스택]

**요약 표시 컴포넌트:**
```typescript
// components/notes/summary-display.tsx
interface SummaryDisplayProps {
  noteId: string;
  summary?: Summary;
  isLoading?: boolean;
  onRegenerate?: () => void;
}

// 불릿 포인트 스타일링
// - shadcn/ui Card 컴포넌트 사용
// - Tailwind CSS로 스타일링
// - 로딩 상태 표시
```

### 파일 위치

[Source: docs/architecture.md#1-기술-스택]

**새로 생성될 파일:**
- `drizzle/schema/summaries.ts` - 요약 테이블 스키마
- `lib/ai/summary-actions.ts` - 요약 관련 서버 액션
- `components/notes/summary-display.tsx` - 요약 표시 컴포넌트
- `components/notes/summary-generator.tsx` - 요약 생성 버튼
- `__tests__/ai/summary-actions.test.ts` - 요약 액션 테스트
- `__tests__/components/summary-display.test.tsx` - 요약 컴포넌트 테스트

**수정될 파일:**
- `drizzle/schema/index.ts` - 스키마 export 추가
- `app/notes/[id]/page.tsx` - 요약 섹션 추가
- `lib/notes/actions.ts` - 노트 수정 시 요약 무효화

### 기술적 제약사항

[Source: docs/architecture.md#6-배포운영]

- **토큰 제한:** 8k 토큰 (Gemini 무료 할당 활용)
- **응답 시간:** 10초 이내
- **요약 길이:** 3-6개 불릿 포인트, 각 20-50자
- **최소 노트 길이:** 100자 이상

### 보안 고려사항

[Source: docs/architecture.md#3-보안]

- **권한 스코프:** 사용자 ID 스코프로 소유자만 요약 조회 가능
- **데이터 보안:** 요약 생성 시 사용자 인증 확인
- **API 보안:** 서버 액션을 통한 안전한 Gemini API 호출

### 성능 최적화

[Source: docs/architecture.md#6-배포운영]

- **중복 방지:** 동일 노트에 대한 중복 요약 생성 방지
- **캐싱:** 생성된 요약은 데이터베이스에 저장하여 재사용
- **로딩 상태:** 사용자 경험을 위한 적절한 로딩 표시

### 테스트 요구사항

[Source: docs/architecture.md#1-기술-스택]

**단위 테스트:**
- 요약 생성 서버 액션 테스트
- 요약 표시 컴포넌트 테스트
- 에러 처리 테스트

**통합 테스트:**
- Gemini API 연동 테스트
- 데이터베이스 저장/조회 테스트
- 전체 요약 생성 플로우 테스트

## Change Log

| Date       | Version | Description                | Author                    |
| ---------- | ------- | -------------------------- | ------------------------- |
| 2025-01-15 | 1.0     | 스토리 4.2 초안 생성       | Scrum Master Bob          |
| 2025-01-15 | 1.1     | 스토리 4.2 구현 완료       | Dev Agent Claude 4 Sonnet |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4

### Debug Log References

- 요약 생성 서버 액션 구현 및 테스트
- 데이터베이스 스키마 마이그레이션 생성
- UI 컴포넌트 통합 및 상호작용 테스트
- 노트 수정 시 요약 무효화 로직 검증

### Completion Notes List

- ✅ summaries 테이블 스키마 정의 완료 (Drizzle ORM)
- ✅ 요약 생성 서버 액션 구현 완료 (generateSummary, getSummary, regenerateSummary, deleteSummary)
- ✅ 노트 내용 길이 검증 로직 구현 (최소 100자)
- ✅ 중복 요약 생성 방지 로직 구현
- ✅ 요약 표시 컴포넌트 구현 (불릿 포인트 스타일링)
- ✅ 요약 생성 버튼 컴포넌트 구현 (로딩 상태 포함)
- ✅ 노트 상세 페이지에 요약 섹션 통합
- ✅ 노트 수정 시 요약 자동 무효화 로직 구현
- ✅ 요약 재생성 및 삭제 기능 구현
- ✅ 단위 테스트 및 컴포넌트 테스트 구현
- ✅ 데이터베이스 마이그레이션 파일 생성 (0001_wakeful_zarda.sql)

### File List

**새로 생성된 파일:**
- `lib/db/schema/summaries.ts` - 요약 테이블 스키마 정의
- `lib/db/schema/index.ts` - 스키마 통합 export
- `lib/ai/summary-actions.ts` - 요약 관련 서버 액션
- `components/notes/summary-display.tsx` - 요약 표시 컴포넌트
- `components/notes/summary-generator.tsx` - 요약 생성 버튼 컴포넌트
- `components/notes/note-summary-section.tsx` - 요약 섹션 통합 컴포넌트
- `__tests__/ai/summary-actions.test.ts` - 요약 액션 테스트
- `__tests__/components/summary-display.test.tsx` - 요약 컴포넌트 테스트
- `drizzle/0001_wakeful_zarda.sql` - 데이터베이스 마이그레이션

**수정된 파일:**
- `lib/ai/types.ts` - 요약 관련 타입 추가
- `lib/notes/actions.ts` - 노트 수정 시 요약 무효화 로직 추가
- `app/notes/[id]/page.tsx` - 요약 섹션 통합
