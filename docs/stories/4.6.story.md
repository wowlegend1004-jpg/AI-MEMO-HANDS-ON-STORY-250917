# Story 4.6: 요약/태그 수동 편집 기능

## Status

Ready for Review

## Story

**As a** 사용자,
**I want** AI가 생성한 요약과 태그를 수동으로 편집할 수 있는 기능,
**so that** AI 결과가 완벽하지 않을 때 직접 수정하여 더 정확하고 개인화된 결과를 얻을 수 있다.

## Acceptance Criteria

1. AI가 생성한 요약을 인라인으로 편집할 수 있어야 한다
2. AI가 생성한 태그를 개별적으로 추가, 삭제, 수정할 수 있어야 한다
3. 편집 중에는 자동 저장 기능이 작동해야 한다
4. 편집 완료 후 변경사항이 데이터베이스에 저장되어야 한다
5. 편집 취소 기능이 제공되어야 한다 (변경사항 되돌리기)
6. 편집 중에는 AI 재생성 버튼이 비활성화되어야 한다
7. 편집 완료 후에는 AI 재생성 버튼이 다시 활성화되어야 한다
8. 요약 편집 시 글자 수 제한이 표시되어야 한다 (최대 500자)
9. 태그 편집 시 최대 태그 개수 제한이 표시되어야 한다 (최대 6개)
10. 편집 모드 진입/종료가 시각적으로 명확하게 표시되어야 한다
11. 모바일 환경에서도 편집 기능이 원활하게 작동해야 한다
12. 편집 중 실수로 페이지를 떠날 때 경고 메시지가 표시되어야 한다

## Tasks / Subtasks

- [x] 요약 편집 기능 구현 (AC: 1, 3, 4, 5, 8, 10, 12)
  - [x] 인라인 편집 가능한 요약 컴포넌트 구현
  - [x] 편집 모드 상태 관리 로직 구현
  - [x] 자동 저장 기능 구현 (디바운싱 적용)
  - [x] 편집 취소 기능 구현
  - [x] 글자 수 제한 표시 및 검증 로직 구현
  - [x] 편집 모드 시각적 표시 구현
  - [x] 페이지 이탈 경고 기능 구현
- [x] 태그 편집 기능 구현 (AC: 2, 3, 4, 5, 9, 10, 12)
  - [x] 태그 개별 편집 가능한 컴포넌트 구현
  - [x] 태그 추가/삭제/수정 UI 구현
  - [x] 태그 개수 제한 검증 로직 구현
  - [x] 태그 중복 방지 로직 구현
  - [x] 태그 편집 상태 관리 구현
  - [x] 편집 모드 시각적 표시 구현
- [x] AI 재생성 버튼 상태 관리 (AC: 6, 7)
  - [x] 편집 중 버튼 비활성화 로직 구현
  - [x] 편집 완료 후 버튼 활성화 로직 구현
  - [x] 상태 변경 시각적 피드백 구현
- [x] 서버 액션 구현 (AC: 4)
  - [x] 요약 수정 서버 액션 구현
  - [x] 태그 수정 서버 액션 구현
  - [x] 데이터베이스 업데이트 로직 구현
  - [x] 에러 처리 및 롤백 로직 구현
- [x] 반응형 디자인 구현 (AC: 11)
  - [x] 모바일 환경 편집 UI 최적화
  - [x] 터치 인터페이스 최적화
  - [x] 작은 화면에서의 편집 경험 개선
- [x] 테스트 구현
  - [x] 요약 편집 컴포넌트 테스트
  - [x] 태그 편집 컴포넌트 테스트
  - [x] 서버 액션 테스트
  - [x] 편집 상태 관리 테스트
  - [x] 반응형 디자인 테스트

## Dev Notes

### 이전 스토리 인사이트

[Source: docs/stories/4.4.story.md#completion-notes-list]

- ✅ AI 요약 및 태그 생성 기능이 완전히 구현되어 있음
- ✅ AI 처리 상태 관리 시스템이 구축되어 있음
- ✅ shadcn/ui 기반 컴포넌트 구조가 마련됨
- ✅ 서버 액션을 통한 안전한 데이터 처리 구조가 완성됨
- ✅ 자동 저장 및 상태 관리 패턴이 확립됨

### 데이터 모델

[Source: docs/architecture.md#2-데이터-모델]

**기존 스키마 활용:**
```typescript
// lib/db/schema/notes.ts
export const notes = pgTable('notes', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});

// lib/db/schema/summaries.ts
export const summaries = pgTable('summaries', {
  id: uuid('id').primaryKey().defaultRandom(),
  noteId: uuid('note_id').notNull().references(() => notes.id, { onDelete: 'cascade' }),
  model: text('model').notNull(),
  content: text('content').notNull(),
  createdAt: timestamp('created_at').defaultNow(),
});

// lib/db/schema/note_tags.ts
export const noteTags = pgTable('note_tags', {
  noteId: uuid('note_id').notNull().references(() => notes.id, { onDelete: 'cascade' }),
  tag: text('tag').notNull(),
}, (table) => ({
  pk: primaryKey({ columns: [table.noteId, table.tag] }),
}));
```

### API 명세

[Source: docs/architecture.md#4-서버-액션]

**새로운 서버 액션:**
```typescript
// lib/ai/actions.ts
export async function updateSummary(
  noteId: string,
  summaryContent: string
): Promise<{ success: boolean; error?: string }> {
  // 1. 사용자 권한 검증
  // 2. 요약 내용 유효성 검사 (길이 제한)
  // 3. 데이터베이스 업데이트
  // 4. 결과 반환
}

export async function updateTags(
  noteId: string,
  tags: string[]
): Promise<{ success: boolean; error?: string }> {
  // 1. 사용자 권한 검증
  // 2. 태그 유효성 검사 (개수, 중복)
  // 3. 기존 태그 삭제 후 새 태그 삽입
  // 4. 결과 반환
}
```

### 컴포넌트 명세

[Source: docs/architecture.md#1-기술-스택]

**편집 가능한 컴포넌트들:**
```typescript
// components/notes/editable-summary.tsx
interface EditableSummaryProps {
  summary: string;
  noteId: string;
  onSave: (content: string) => Promise<void>;
  onCancel: () => void;
  maxLength?: number;
  isEditing?: boolean;
  onEditStart?: () => void;
  onEditEnd?: () => void;
}

// components/notes/editable-tags.tsx
interface EditableTagsProps {
  tags: string[];
  noteId: string;
  onSave: (tags: string[]) => Promise<void>;
  onCancel: () => void;
  maxTags?: number;
  isEditing?: boolean;
  onEditStart?: () => void;
  onEditEnd?: () => void;
}

// components/notes/edit-mode-indicator.tsx
interface EditModeIndicatorProps {
  isEditing: boolean;
  onSave: () => void;
  onCancel: () => void;
  hasChanges: boolean;
}
```

### 파일 위치

[Source: docs/architecture.md#1-기술-스택]

**새로 생성될 파일:**
- `components/notes/editable-summary.tsx` - 편집 가능한 요약 컴포넌트
- `components/notes/editable-tags.tsx` - 편집 가능한 태그 컴포넌트
- `components/notes/edit-mode-indicator.tsx` - 편집 모드 표시 컴포넌트
- `lib/ai/edit-actions.ts` - 편집 관련 서버 액션
- `hooks/use-editable-content.ts` - 편집 상태 관리 훅
- `__tests__/components/notes/editable-summary.test.tsx` - 요약 편집 테스트
- `__tests__/components/notes/editable-tags.test.tsx` - 태그 편집 테스트
- `__tests__/lib/ai/edit-actions.test.ts` - 편집 액션 테스트

**수정될 파일:**
- `components/notes/summary-generator.tsx` - 편집 기능 통합
- `components/notes/tag-generator.tsx` - 편집 기능 통합
- `app/notes/[id]/page.tsx` - 편집 모드 UI 통합
- `lib/ai/actions.ts` - 편집 액션 추가

### 기술적 제약사항

[Source: docs/architecture.md#6-배포운영]

- **요약 길이:** 최대 500자 제한
- **태그 개수:** 최대 6개 제한
- **자동 저장:** 2초 디바운싱 적용
- **편집 모드:** 한 번에 하나의 섹션만 편집 가능
- **데이터 일관성:** 트랜잭션을 통한 원자적 업데이트

### 보안 고려사항

[Source: docs/architecture.md#3-보안]

- **권한 검증:** 사용자별 노트 소유권 확인
- **입력 검증:** XSS 방지를 위한 내용 검증
- **SQL 인젝션:** Drizzle ORM을 통한 안전한 쿼리
- **CSRF 보호:** 서버 액션을 통한 CSRF 방지

### 성능 최적화

[Source: docs/architecture.md#6-배포운영]

- **디바운싱:** 자동 저장을 위한 2초 지연
- **메모이제이션:** React.memo를 통한 불필요한 리렌더링 방지
- **상태 최적화:** 로컬 상태와 서버 상태 분리
- **렌더링 최적화:** 조건부 렌더링을 통한 성능 개선

### Testing

**테스트 파일 위치:**
- `__tests__/components/notes/` - 컴포넌트 테스트
- `__tests__/lib/ai/` - 서버 액션 테스트
- `__tests__/hooks/` - 훅 테스트

**테스트 표준:**
- Jest + React Testing Library 사용
- 사용자 상호작용 중심의 테스트 작성
- 접근성 테스트 포함
- 모바일 환경 테스트 포함

**특정 테스트 요구사항:**
- 편집 모드 진입/종료 테스트
- 자동 저장 기능 테스트
- 유효성 검사 테스트
- 에러 처리 테스트
- 반응형 디자인 테스트

## Change Log

| Date       | Version | Description                | Author                    |
| ---------- | ------- | -------------------------- | ------------------------- |
| 2025-01-15 | 1.0     | 스토리 4.6 초안 생성       | Scrum Master Bob          |
| 2025-01-15 | 1.1     | 스토리 4.6 구현 완료       | Dev Agent Claude 4 Sonnet |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4

### Debug Log References

- 요약/태그 편집 기능 구현 및 통합
- 편집 상태 관리 시스템 개발
- 자동 저장 및 유효성 검사 로직 구현
- 반응형 디자인 및 접근성 고려
- 포괄적인 테스트 코드 작성

### Completion Notes List

- ✅ 편집 가능한 요약 컴포넌트 구현 완료 (EditableSummary)
- ✅ 편집 가능한 태그 컴포넌트 구현 완료 (EditableTags)
- ✅ 편집 모드 표시 컴포넌트 구현 완료 (EditModeIndicator)
- ✅ 편집 관련 서버 액션 구현 완료 (updateSummary, updateTags, deleteSummary, deleteTags)
- ✅ 편집 상태 관리 훅 구현 완료 (useEditableContent)
- ✅ 기존 컴포넌트에 편집 기능 통합 완료 (SummaryDisplay, TagDisplay, NoteSummarySection, NoteTagSection)
- ✅ 자동 저장 기능 구현 완료 (2초 디바운싱)
- ✅ 유효성 검사 로직 구현 완료 (글자 수 제한, 태그 개수 제한, 중복 방지)
- ✅ 페이지 이탈 경고 기능 구현 완료
- ✅ 키보드 단축키 지원 구현 완료 (Ctrl+Enter 저장, Esc 취소)
- ✅ 반응형 디자인 구현 완료 (모바일 최적화)
- ✅ 접근성 고려사항 구현 완료 (ARIA 레이블, 키보드 네비게이션)
- ✅ 포괄적인 테스트 코드 작성 완료 (컴포넌트, 훅, 서버 액션 테스트)

### File List

**새로 생성된 파일:**
- `components/notes/editable-summary.tsx` - 편집 가능한 요약 컴포넌트
- `components/notes/editable-tags.tsx` - 편집 가능한 태그 컴포넌트
- `components/notes/edit-mode-indicator.tsx` - 편집 모드 표시 컴포넌트
- `lib/ai/edit-actions.ts` - 편집 관련 서버 액션
- `hooks/use-editable-content.ts` - 편집 상태 관리 훅
- `__tests__/components/notes/editable-summary.test.tsx` - 요약 편집 컴포넌트 테스트
- `__tests__/components/notes/editable-tags.test.tsx` - 태그 편집 컴포넌트 테스트
- `__tests__/lib/ai/edit-actions.test.ts` - 편집 액션 테스트
- `__tests__/hooks/use-editable-content.test.ts` - 편집 상태 관리 훅 테스트

**수정된 파일:**
- `components/notes/note-summary-section.tsx` - 편집 기능 통합
- `components/notes/note-tag-section.tsx` - 편집 기능 통합
- `components/notes/summary-display.tsx` - 편집 버튼 추가
- `components/notes/tag-display.tsx` - 편집 버튼 추가
