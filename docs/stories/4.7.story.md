# Story 4.7: AI 처리 에러 핸들링

## Status

Ready for Review

## Story

**As a** 사용자,
**I want** AI 처리 중 발생하는 다양한 에러 상황에 대한 적절한 피드백과 복구 옵션을 제공받을 수 있는 기능,
**so that** AI 기능 사용 중 문제가 발생해도 명확한 상황 파악과 해결 방법을 통해 원활한 사용 경험을 유지할 수 있다.

## Acceptance Criteria

1. API 호출 실패 시 사용자에게 명확한 에러 메시지를 표시해야 한다
2. 네트워크 연결 문제 시 재시도 옵션을 제공해야 한다
3. API 할당량 초과 시 적절한 안내 메시지와 대안을 제시해야 한다
4. 잘못된 입력으로 인한 AI 처리 실패 시 구체적인 원인을 알려줘야 한다
5. 처리 시간 초과 시 타임아웃 메시지와 재시도 옵션을 제공해야 한다
6. 서버 에러 발생 시 일반적인 에러 메시지와 고객 지원 안내를 표시해야 한다
7. 에러 발생 시 기존 데이터는 보존되어야 한다
8. 에러 상태에서 정상 상태로 복구할 수 있는 명확한 액션을 제공해야 한다
9. 에러 로그가 적절히 기록되어 디버깅이 가능해야 한다
10. 사용자가 에러 상황을 이해하기 쉽도록 시각적 표시를 제공해야 한다
11. 모바일 환경에서도 에러 메시지가 명확하게 표시되어야 한다
12. 에러 발생 시 AI 기능 사용을 일시적으로 제한할 수 있어야 한다

## Tasks / Subtasks

- [x] 에러 타입 정의 및 분류 시스템 구현 (AC: 1, 4, 6, 9)
  - [x] AI 처리 에러 타입 enum 정의
  - [x] 에러 심각도 레벨 분류 시스템 구현
  - [x] 에러 메시지 템플릿 시스템 구현
  - [x] 에러 로깅 구조체 정의
- [x] API 에러 핸들링 로직 구현 (AC: 1, 2, 3, 5, 6)
  - [x] Gemini API 에러 응답 파싱 로직 구현
  - [x] 네트워크 에러 감지 및 분류 로직 구현
  - [x] API 할당량 초과 감지 로직 구현
  - [x] 타임아웃 에러 처리 로직 구현
  - [x] 재시도 메커니즘 구현 (지수 백오프)
- [x] 사용자 피드백 UI 컴포넌트 구현 (AC: 1, 3, 4, 6, 10, 11)
  - [x] 에러 메시지 표시 컴포넌트 구현
  - [x] 에러 상태 아이콘 및 시각적 표시 구현
  - [x] 재시도 버튼 컴포넌트 구현
  - [x] 에러 상세 정보 모달 구현
  - [x] 모바일 최적화 에러 UI 구현
- [x] 에러 복구 메커니즘 구현 (AC: 2, 5, 8, 12)
  - [x] 자동 재시도 로직 구현
  - [x] 수동 재시도 기능 구현
  - [x] 에러 상태 초기화 기능 구현
  - [x] AI 기능 일시 중단/재개 기능 구현
- [x] 데이터 보존 및 무결성 보장 (AC: 7)
  - [x] 에러 발생 시 기존 데이터 롤백 로직 구현
  - [x] 부분적 처리 실패 시 데이터 복구 로직 구현
  - [x] 트랜잭션 기반 안전한 데이터 처리 구현
- [x] 로깅 및 모니터링 시스템 구현 (AC: 9)
  - [x] 에러 로그 기록 시스템 구현
  - [x] 에러 통계 수집 시스템 구현
  - [x] 디버깅을 위한 상세 로그 시스템 구현
- [x] 테스트 구현
  - [x] 에러 핸들링 로직 단위 테스트
  - [x] 에러 UI 컴포넌트 테스트
  - [x] API 에러 시나리오 통합 테스트
  - [x] 에러 복구 메커니즘 테스트
  - [x] 모바일 에러 UI 테스트

## Dev Notes

### 이전 스토리 인사이트

[Source: docs/stories/4.6.story.md#completion-notes-list]

- ✅ AI 요약 및 태그 생성 기능이 완전히 구현되어 있음
- ✅ AI 처리 상태 관리 시스템이 구축되어 있음
- ✅ 편집 기능을 통한 사용자 제어 시스템이 완성됨
- ✅ 자동 저장 및 상태 관리 패턴이 확립됨
- ✅ shadcn/ui 기반 컴포넌트 구조가 마련됨

### 데이터 모델

[Source: docs/architecture.md#2-데이터-모델]

**기존 스키마 활용:**
```typescript
// lib/db/schema/notes.ts
export const notes = pgTable('notes', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});

// lib/db/schema/summaries.ts
export const summaries = pgTable('summaries', {
  id: uuid('id').primaryKey().defaultRandom(),
  noteId: uuid('note_id').notNull().references(() => notes.id, { onDelete: 'cascade' }),
  model: text('model').notNull(),
  content: text('content').notNull(),
  createdAt: timestamp('created_at').defaultNow(),
});

// lib/db/schema/note_tags.ts
export const noteTags = pgTable('note_tags', {
  noteId: uuid('note_id').notNull().references(() => notes.id, { onDelete: 'cascade' }),
  tag: text('tag').notNull(),
}, (table) => ({
  pk: primaryKey({ columns: [table.noteId, table.tag] }),
}));
```

**새로운 에러 로깅 스키마:**
```typescript
// lib/db/schema/error_logs.ts
export const errorLogs = pgTable('error_logs', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull(),
  errorType: text('error_type').notNull(),
  errorMessage: text('error_message').notNull(),
  errorDetails: jsonb('error_details'),
  severity: text('severity').notNull(), // 'low', 'medium', 'high', 'critical'
  context: jsonb('context'), // 요청 컨텍스트 정보
  resolved: boolean('resolved').default(false),
  createdAt: timestamp('created_at').defaultNow(),
});
```

### API 명세

[Source: docs/architecture.md#4-서버-액션]

**기존 AI 액션 확장:**
```typescript
// lib/ai/actions.ts
export async function generateSummaryWithErrorHandling(
  noteId: string,
  content: string
): Promise<{ success: boolean; data?: any; error?: AIError }> {
  try {
    // 1. 입력 유효성 검사
    // 2. Gemini API 호출
    // 3. 응답 처리
    // 4. 데이터베이스 저장
  } catch (error) {
    // 1. 에러 타입 분류
    // 2. 에러 로그 기록
    // 3. 사용자 친화적 에러 메시지 생성
    // 4. 에러 응답 반환
  }
}

// lib/ai/error-handler.ts
export interface AIError {
  type: 'API_ERROR' | 'NETWORK_ERROR' | 'QUOTA_EXCEEDED' | 'TIMEOUT' | 'VALIDATION_ERROR' | 'SERVER_ERROR';
  message: string;
  details?: any;
  retryable: boolean;
  severity: 'low' | 'medium' | 'high' | 'critical';
}

export function classifyError(error: any): AIError {
  // 에러 분류 로직
}

export function logError(error: AIError, context: any): void {
  // 에러 로깅 로직
}
```

### 컴포넌트 명세

[Source: docs/architecture.md#1-기술-스택]

**에러 처리 컴포넌트들:**
```typescript
// components/ai/error-display.tsx
interface ErrorDisplayProps {
  error: AIError;
  onRetry?: () => void;
  onDismiss?: () => void;
  showDetails?: boolean;
}

// components/ai/error-boundary.tsx
interface ErrorBoundaryProps {
  children: React.ReactNode;
  fallback?: React.ComponentType<{ error: Error; reset: () => void }>;
}

// components/ai/retry-button.tsx
interface RetryButtonProps {
  onRetry: () => void;
  disabled?: boolean;
  loading?: boolean;
  maxRetries?: number;
  currentRetries?: number;
}

// components/ai/error-status-indicator.tsx
interface ErrorStatusIndicatorProps {
  status: 'idle' | 'loading' | 'error' | 'success';
  error?: AIError;
  onRetry?: () => void;
}
```

### 파일 위치

[Source: docs/architecture.md#1-기술-스택]

**새로 생성될 파일:**
- `lib/ai/error-handler.ts` - 에러 분류 및 처리 로직
- `lib/ai/error-types.ts` - 에러 타입 정의
- `lib/ai/retry-manager.ts` - 재시도 관리 로직
- `components/ai/error-display.tsx` - 에러 메시지 표시 컴포넌트
- `components/ai/error-boundary.tsx` - 에러 경계 컴포넌트
- `components/ai/retry-button.tsx` - 재시도 버튼 컴포넌트
- `components/ai/error-status-indicator.tsx` - 에러 상태 표시 컴포넌트
- `hooks/use-error-handler.ts` - 에러 처리 훅
- `hooks/use-retry.ts` - 재시도 관리 훅
- `__tests__/lib/ai/error-handler.test.ts` - 에러 핸들러 테스트
- `__tests__/components/ai/error-display.test.tsx` - 에러 UI 테스트

**수정될 파일:**
- `lib/ai/actions.ts` - 에러 핸들링 통합
- `lib/ai/gemini-client.ts` - API 에러 처리 강화
- `components/ai/ai-status-indicator.tsx` - 에러 상태 표시 추가
- `components/notes/summary-generator.tsx` - 에러 처리 통합
- `components/notes/tag-generator.tsx` - 에러 처리 통합

### 기술적 제약사항

[Source: docs/architecture.md#6-배포운영]

- **API 할당량:** Gemini API 무료 할당량 고려
- **재시도 제한:** 최대 3회 재시도, 지수 백오프 적용
- **에러 로그:** 민감한 정보 제외, 30일 보관
- **타임아웃:** API 호출 30초 타임아웃
- **사용자 경험:** 에러 발생 시에도 기존 데이터 보존

### 보안 고려사항

[Source: docs/architecture.md#3-보안]

- **에러 로그:** 민감한 사용자 데이터 제외
- **API 키:** 에러 로그에 API 키 노출 방지
- **사용자 정보:** 에러 컨텍스트에서 개인정보 보호
- **에러 메시지:** 내부 시스템 정보 노출 방지

### 성능 최적화

[Source: docs/architecture.md#6-배포운영]

- **에러 로깅:** 비동기 로깅으로 성능 영향 최소화
- **재시도:** 지수 백오프로 서버 부하 방지
- **에러 UI:** 조건부 렌더링으로 불필요한 리렌더링 방지
- **메모리 관리:** 에러 상태 정리로 메모리 누수 방지

### Testing

**테스트 파일 위치:**
- `__tests__/lib/ai/` - 에러 핸들링 로직 테스트
- `__tests__/components/ai/` - 에러 UI 컴포넌트 테스트
- `__tests__/hooks/` - 에러 처리 훅 테스트

**테스트 표준:**
- Jest + React Testing Library 사용
- 에러 시나리오 중심의 테스트 작성
- API 모킹을 통한 에러 상황 시뮬레이션
- 사용자 상호작용 테스트 포함

**특정 테스트 요구사항:**
- 다양한 에러 타입별 처리 테스트
- 재시도 메커니즘 테스트
- 에러 UI 표시 테스트
- 데이터 보존 테스트
- 모바일 에러 UI 테스트

## Change Log

| Date       | Version | Description                | Author                    |
| ---------- | ------- | -------------------------- | ------------------------- |
| 2025-01-15 | 1.0     | 스토리 4.7 초안 생성       | Scrum Master Bob          |
| 2025-01-15 | 1.1     | 스토리 4.7 구현 완료       | Dev Agent Claude 4 Sonnet |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4

### Debug Log References

- AI 처리 에러 핸들링 시스템 구축
- 에러 분류 및 로깅 시스템 개발
- 재시도 메커니즘 및 사용자 피드백 UI 구현
- 기존 AI 컴포넌트에 에러 핸들링 통합
- 포괄적인 테스트 코드 작성

### Completion Notes List

- ✅ 에러 타입 정의 및 분류 시스템 구현 완료 (AIError, ERROR_SEVERITY)
- ✅ 에러 핸들러 및 로깅 시스템 구현 완료 (error-handler.ts)
- ✅ 재시도 관리 시스템 구현 완료 (retry-manager.ts)
- ✅ 에러 처리 훅 구현 완료 (use-error-handler.ts, use-retry.ts)
- ✅ 에러 UI 컴포넌트 구현 완료 (ErrorDisplay, RetryButton, ErrorStatusIndicator, ErrorBoundary)
- ✅ 기존 AI 액션에 에러 핸들링 통합 완료 (actions.ts)
- ✅ 기존 AI 상태 표시 컴포넌트에 에러 핸들링 통합 완료 (ai-status-indicator.tsx)
- ✅ 요약/태그 생성기에 에러 핸들링 통합 완료 (summary-generator.tsx, tag-generator.tsx)
- ✅ 데이터베이스 에러 로그 스키마 추가 완료 (error_logs.ts)
- ✅ 포괄적인 테스트 코드 작성 완료 (에러 핸들러, UI 컴포넌트, 훅 테스트)
- ✅ 지수 백오프 재시도 메커니즘 구현 완료
- ✅ 사용자 친화적 에러 메시지 시스템 구현 완료
- ✅ 모바일 최적화 에러 UI 구현 완료
- ✅ 접근성 고려사항 구현 완료 (ARIA 레이블, 키보드 네비게이션)

### File List

**새로 생성된 파일:**
- `lib/db/schema/error_logs.ts` - 에러 로그 데이터베이스 스키마
- `lib/ai/error-handler.ts` - AI 에러 핸들링 시스템
- `lib/ai/retry-manager.ts` - 재시도 관리 시스템
- `hooks/use-error-handler.ts` - 에러 처리 상태 관리 훅
- `hooks/use-retry.ts` - 재시도 전용 훅
- `components/ai/error-boundary.tsx` - 에러 경계 컴포넌트
- `components/ai/retry-button.tsx` - 재시도 버튼 컴포넌트
- `components/ai/error-status-indicator.tsx` - 에러 상태 표시 컴포넌트
- `__tests__/lib/ai/error-handler.test.ts` - 에러 핸들러 테스트
- `__tests__/components/ai/error-display.test.tsx` - 에러 UI 컴포넌트 테스트
- `__tests__/components/ai/retry-button.test.tsx` - 재시도 버튼 테스트
- `__tests__/hooks/use-error-handler.test.ts` - 에러 핸들링 훅 테스트

**수정된 파일:**
- `lib/db/schema/index.ts` - 에러 로그 스키마 export 추가
- `lib/ai/actions.ts` - 에러 핸들링이 통합된 AI 액션 추가
- `components/ai/ai-status-indicator.tsx` - 에러 핸들링 통합
- `components/notes/summary-generator.tsx` - 에러 핸들링 통합
- `components/notes/tag-generator.tsx` - 에러 핸들링 통합
