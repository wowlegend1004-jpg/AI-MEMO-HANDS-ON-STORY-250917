# Story 4.3: 노트 내용 기반 자동 태그 생성

## Status

Ready for Review

## Story

**As a** 사용자,
**I want** 노트 내용을 기반으로 AI가 자동으로 관련성 높은 태그를 최대 6개까지 생성하는 기능,
**so that** 노트를 체계적으로 분류하고 검색하기 쉽게 만들 수 있다.

## Acceptance Criteria

1. 노트 내용이 100자 이상일 때만 태그 생성이 가능해야 한다
2. 태그는 최대 6개까지 생성되어야 한다
3. 각 태그는 1-3단어로 구성되어야 한다
4. 태그 생성 시 로딩 상태가 표시되어야 한다
5. 태그 생성이 완료되면 노트 상세 페이지에 표시되어야 한다
6. 태그 생성 실패 시 적절한 에러 메시지가 표시되어야 한다
7. 태그 생성 시간이 10초를 초과하면 타임아웃 처리가 되어야 한다
8. 동일한 노트에 대해 중복 태그 생성을 방지해야 한다
9. 태그는 노트 수정 시 자동으로 재생성되어야 한다
10. 태그 생성 이력이 데이터베이스에 저장되어야 한다
11. 생성된 태그는 기존 태그와 중복되지 않아야 한다
12. 태그는 노트 내용의 핵심 키워드를 반영해야 한다

## Tasks / Subtasks

- [x] 태그 생성 서버 액션 구현 (AC: 1, 4, 6, 7, 8, 11)
  - [x] 노트 내용 길이 검증 함수 구현
  - [x] Gemini API를 통한 태그 생성 함수 구현
  - [x] 태그 생성 상태 관리 (로딩, 성공, 실패)
  - [x] 중복 태그 생성 방지 로직 구현
  - [x] 타임아웃 처리 및 에러 핸들링
  - [x] 기존 태그와의 중복 검사 로직 구현
- [x] 데이터베이스 스키마 확장 (AC: 10)
  - [x] note_tags 테이블 스키마 정의
  - [x] 태그 생성 이력 저장 로직 구현
  - [x] 태그 데이터 조회 함수 구현
- [x] UI 컴포넌트 구현 (AC: 2, 3, 5)
  - [x] 태그 표시 컴포넌트 구현
  - [x] 태그 생성 버튼 및 로딩 상태 표시
  - [x] 태그 칩 스타일링 (shadcn/ui 기반)
  - [x] 노트 상세 페이지에 태그 섹션 통합
- [x] 태그 재생성 기능 (AC: 9)
  - [x] 노트 수정 시 태그 무효화 로직
  - [x] 수동 태그 재생성 버튼 구현
  - [x] 기존 태그 데이터 업데이트 처리
- [x] 태그 관련성 검증 (AC: 12)
  - [x] 태그 품질 검증 로직 구현
  - [x] 핵심 키워드 추출 및 매칭 검증
- [x] 테스트 구현
  - [x] 태그 생성 서버 액션 단위 테스트
  - [x] 태그 UI 컴포넌트 테스트
  - [x] 태그 생성 통합 테스트
  - [x] 에러 케이스 테스트

## Dev Notes

### 이전 스토리 인사이트

[Source: docs/stories/4.2.story.md#completion-notes-list]

- ✅ Gemini API 클라이언트가 완전히 구현되어 있음
- ✅ 요약 생성 서버 액션 구조가 완성되어 태그 생성에 재사용 가능
- ✅ 환경변수 설정 및 에러 처리가 완료됨
- ✅ 토큰 사용량 추적 시스템이 구축됨
- ✅ 서버 액션을 통한 안전한 API 호출 구조가 마련됨
- ✅ 데이터베이스 마이그레이션 시스템이 구축됨

### 데이터 모델

[Source: docs/architecture.md#2-데이터-모델]

**note_tags 테이블 스키마:**
```sql
CREATE TABLE note_tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  note_id UUID NOT NULL REFERENCES notes(id) ON DELETE CASCADE,
  tag VARCHAR(50) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_note_tags_note_id ON note_tags(note_id);
CREATE INDEX idx_note_tags_tag ON note_tags(tag);
CREATE UNIQUE INDEX idx_note_tags_note_tag ON note_tags(note_id, tag);
```

**Drizzle 스키마 정의:**
```typescript
// drizzle/schema/note_tags.ts
export const noteTags = pgTable('note_tags', {
  id: uuid('id').primaryKey().defaultRandom(),
  noteId: uuid('note_id').notNull().references(() => notes.id, { onDelete: 'cascade' }),
  tag: varchar('tag', { length: 50 }).notNull(),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow()
});
```

### API 명세

[Source: docs/architecture.md#4-서버-액션]

**태그 생성 서버 액션:**
```typescript
// lib/ai/actions.ts
export async function generateTags(noteId: string): Promise<TagResult> {
  // 1. 노트 내용 조회 및 검증
  // 2. 기존 태그 존재 여부 확인
  // 3. Gemini API 호출하여 태그 생성
  // 4. 태그 데이터베이스 저장
  // 5. 결과 반환
}

export async function getTags(noteId: string): Promise<Tag[]> {
  // 노트의 태그 목록 조회
}

export async function regenerateTags(noteId: string): Promise<TagResult> {
  // 기존 태그 삭제 후 새로 생성
}
```

### 컴포넌트 명세

[Source: docs/architecture.md#1-기술-스택]

**태그 표시 컴포넌트:**
```typescript
// components/notes/tag-display.tsx
interface TagDisplayProps {
  noteId: string;
  tags?: Tag[];
  isLoading?: boolean;
  onRegenerate?: () => void;
}

// 태그 칩 스타일링
// - shadcn/ui Badge 컴포넌트 사용
// - Tailwind CSS로 스타일링
// - 로딩 상태 표시
```

### 파일 위치

[Source: docs/architecture.md#1-기술-스택]

**새로 생성될 파일:**
- `drizzle/schema/note_tags.ts` - 태그 테이블 스키마
- `lib/ai/tag-actions.ts` - 태그 관련 서버 액션
- `components/notes/tag-display.tsx` - 태그 표시 컴포넌트
- `components/notes/tag-generator.tsx` - 태그 생성 버튼
- `__tests__/ai/tag-actions.test.ts` - 태그 액션 테스트
- `__tests__/components/tag-display.test.tsx` - 태그 컴포넌트 테스트

**수정될 파일:**
- `drizzle/schema/index.ts` - 스키마 export 추가
- `app/notes/[id]/page.tsx` - 태그 섹션 추가
- `lib/notes/actions.ts` - 노트 수정 시 태그 무효화
- `lib/ai/types.ts` - 태그 관련 타입 추가

### 기술적 제약사항

[Source: docs/architecture.md#6-배포운영]

- **토큰 제한:** 8k 토큰 (Gemini 무료 할당 활용)
- **응답 시간:** 10초 이내
- **태그 개수:** 최대 6개
- **태그 길이:** 1-3단어 (최대 50자)
- **최소 노트 길이:** 100자 이상

### 보안 고려사항

[Source: docs/architecture.md#3-보안]

- **권한 스코프:** 사용자 ID 스코프로 소유자만 태그 조회 가능
- **데이터 보안:** 태그 생성 시 사용자 인증 확인
- **API 보안:** 서버 액션을 통한 안전한 Gemini API 호출

### 성능 최적화

[Source: docs/architecture.md#6-배포운영]

- **중복 방지:** 동일 노트에 대한 중복 태그 생성 방지
- **캐싱:** 생성된 태그는 데이터베이스에 저장하여 재사용
- **로딩 상태:** 사용자 경험을 위한 적절한 로딩 표시
- **인덱싱:** 태그 검색을 위한 GIN 인덱스 활용

### 테스트 요구사항

[Source: docs/architecture.md#1-기술-스택]

**단위 테스트:**
- 태그 생성 서버 액션 테스트
- 태그 표시 컴포넌트 테스트
- 에러 처리 테스트
- 태그 중복 검사 테스트

**통합 테스트:**
- Gemini API 연동 테스트
- 데이터베이스 저장/조회 테스트
- 전체 태그 생성 플로우 테스트
- 태그 관련성 검증 테스트

## Change Log

| Date       | Version | Description                | Author                    |
| ---------- | ------- | -------------------------- | ------------------------- |
| 2025-01-15 | 1.0     | 스토리 4.3 초안 생성       | Scrum Master Bob          |
| 2025-01-15 | 1.1     | 스토리 4.3 구현 완료       | Dev Agent Claude 4 Sonnet |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4

### Debug Log References

- 태그 생성 서버 액션 구현 및 테스트
- 데이터베이스 스키마 마이그레이션 생성
- UI 컴포넌트 통합 및 상호작용 테스트
- 노트 수정 시 태그 무효화 로직 검증

### Completion Notes List

- ✅ note_tags 테이블 스키마 정의 완료 (Drizzle ORM)
- ✅ 태그 생성 서버 액션 구현 완료 (generateTags, getTags, regenerateTags, deleteTags)
- ✅ 노트 내용 길이 검증 로직 구현 (최소 100자)
- ✅ 중복 태그 생성 방지 로직 구현
- ✅ 태그 표시 컴포넌트 구현 (Badge 스타일링)
- ✅ 태그 생성 버튼 컴포넌트 구현 (로딩 상태 포함)
- ✅ 노트 상세 페이지에 태그 섹션 통합
- ✅ 노트 수정 시 태그 자동 무효화 로직 구현
- ✅ 태그 재생성 및 삭제 기능 구현
- ✅ 단위 테스트 및 컴포넌트 테스트 구현
- ✅ 데이터베이스 마이그레이션 파일 생성 (0002_mysterious_mister_fear.sql)

### File List

**새로 생성된 파일:**
- `lib/db/schema/note_tags.ts` - 태그 테이블 스키마 정의
- `lib/ai/tag-actions.ts` - 태그 관련 서버 액션
- `components/notes/tag-display.tsx` - 태그 표시 컴포넌트
- `components/notes/tag-generator.tsx` - 태그 생성 버튼 컴포넌트
- `components/notes/note-tag-section.tsx` - 태그 섹션 통합 컴포넌트
- `__tests__/ai/tag-actions.test.ts` - 태그 액션 테스트
- `__tests__/components/notes/tag-display.test.tsx` - 태그 표시 컴포넌트 테스트
- `__tests__/components/notes/tag-generator.test.tsx` - 태그 생성기 컴포넌트 테스트
- `drizzle/0002_mysterious_mister_fear.sql` - 데이터베이스 마이그레이션

**수정된 파일:**
- `lib/ai/types.ts` - 태그 관련 타입 추가
- `lib/notes/actions.ts` - 노트 수정 시 태그 무효화 로직 추가
- `app/notes/[id]/page.tsx` - 태그 섹션 통합
- `lib/db/schema/index.ts` - 스키마 export 추가
