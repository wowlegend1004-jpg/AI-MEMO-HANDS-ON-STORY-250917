# Story 2.3: 노트 상세 조회, 수정 및 자동 저장

## Status

Ready for Review

## Story

**As a** 로그인한 사용자,
**I want** 개별 노트의 상세 내용을 조회하고, 실시간으로 수정하며, 자동 저장 기능을 사용할 수 있는 기능,
**so that** 노트의 전체 내용을 확인하고 편집할 수 있으며, 실수로 데이터를 잃지 않고 안전하게 작업할 수 있다.

## Acceptance Criteria

1. 노트 상세 페이지에서 노트의 제목과 본문을 모두 조회할 수 있어야 한다
2. 노트 제목과 본문을 실시간으로 수정할 수 있어야 한다
3. 수정 내용이 3초마다 자동으로 저장되어야 한다
4. 자동 저장 상태를 사용자에게 시각적으로 표시해야 한다 (저장 중, 저장 완료, 저장 실패)
5. 수정된 내용이 저장되면 updated_at 시간이 업데이트되어야 한다
6. 페이지를 새로고침하거나 다시 방문했을 때 마지막 저장된 내용이 표시되어야 한다
7. 네트워크 오류 시 저장 실패 메시지가 표시되어야 한다
8. 저장 실패 시 재시도 기능이 제공되어야 한다
9. 노트가 존재하지 않는 경우 404 에러 페이지가 표시되어야 한다
10. 권한이 없는 노트에 접근할 경우 403 에러 페이지가 표시되어야 한다

## Tasks / Subtasks

- [x] 노트 상세 조회 API 구현 (AC: 1, 6, 9, 10)
  - [x] Drizzle ORM을 사용한 단일 노트 조회 쿼리 구현
  - [x] 사용자 권한 검증 로직 구현
  - [x] 노트 존재 여부 검증 로직 구현
  - [x] 에러 핸들링 (404, 403) 구현
- [x] 노트 수정 API 구현 (AC: 2, 5, 7, 8)
  - [x] Drizzle ORM을 사용한 노트 업데이트 쿼리 구현
  - [x] updated_at 필드 자동 업데이트 로직 구현
  - [x] 네트워크 오류 핸들링 구현
  - [x] 재시도 로직 구현
- [x] 자동 저장 기능 구현 (AC: 3, 4, 7, 8)
  - [x] 3초 디바운스 타이머 구현
  - [x] 자동 저장 상태 관리 (저장 중, 완료, 실패)
  - [x] 저장 상태 UI 표시 로직 구현
  - [x] 저장 실패 시 재시도 로직 구현
- [x] 노트 상세 페이지 UI 구현 (AC: 1, 2, 4, 6, 7, 8, 9, 10)
  - [x] 노트 제목 편집 UI 컴포넌트 구현
  - [x] 노트 본문 편집 UI 컴포넌트 구현
  - [x] 자동 저장 상태 표시 UI 컴포넌트 구현
  - [x] 404/403 에러 페이지 컴포넌트 구현
  - [x] 로딩 상태 UI 컴포넌트 구현
- [x] 실시간 편집 기능 구현 (AC: 2, 3, 4)
  - [x] 제목 입력 필드 실시간 업데이트 구현
  - [x] 본문 텍스트 영역 실시간 업데이트 구현
  - [x] 디바운스 타이머 통합 구현
  - [x] 저장 상태 실시간 업데이트 구현
- [x] 반응형 디자인 적용 (AC: 1, 2, 4, 6, 7, 8, 9, 10)
  - [x] 모바일 화면 최적화
  - [x] 태블릿 화면 최적화
  - [x] 데스크톱 화면 최적화

## Dev Notes

### 이전 스토리 인사이트

[Source: Story 2.2 Dev Agent Records]

- ✅ 노트 목록 조회 및 페이지네이션 기능 구현 완료
- ✅ 노트 상세 페이지 기본 구조 구현 완료 (`app/notes/[id]/page.tsx`)
- ✅ Drizzle ORM을 사용한 노트 데이터 모델 완성
- ✅ 사용자 권한 스코프 기반 데이터 접근 제어 구현

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

- **프레임워크:** Next.js (App Router, Server Actions)
- **UI:** shadcn/ui + Tailwind + Radix UI
- **DB/인증:** Supabase (Postgres, Auth, Storage)
- **ORM:** Drizzle ORM

### 데이터베이스 스키마

[Source: lib/db/schema/notes.ts]

```typescript
export const notes = pgTable('notes', {
    id: uuid('id').defaultRandom().primaryKey(),
    userId: uuid('user_id').notNull(),
    title: text('title').notNull().default('제목 없음'),
    content: text('content'),
    createdAt: timestamp('created_at', { withTimezone: true }).defaultNow(),
    updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow()
})
```

### 기존 구현된 파일들

[Source: Story 2.2 File List]

- `lib/notes/actions.ts` - 노트 관련 Server Actions (getNotesPaginated 함수 포함)
- `app/notes/[id]/page.tsx` - 노트 상세 조회 페이지 (기본 구조)
- `lib/db/connection.ts` - 데이터베이스 연결 설정
- `lib/db/schema/notes.ts` - 노트 데이터 모델 스키마

### 자동 저장 요구사항

- **디바운스 시간:** 3초 (사용자가 입력을 멈춘 후 3초 후 저장)
- **저장 상태 표시:** 저장 중(회전 아이콘), 저장 완료(체크 아이콘), 저장 실패(경고 아이콘)
- **재시도 로직:** 저장 실패 시 3초 후 자동 재시도, 최대 3회 시도

### 보안 요구사항

[Source: docs/architecture.md#3-보안]

- 모든 Drizzle 쿼리는 사용자 ID 스코프를 WHERE로 직접 강제
- Supabase RLS 정책으로 추가 보안 레이어 제공
- 노트 소유자만 조회/수정 가능

### 재사용 가능한 컴포넌트

- `components/ui/input.tsx` - 제목 입력 필드
- `components/ui/textarea.tsx` - 본문 편집 영역
- `components/ui/button.tsx` - 저장 버튼 (필요시)
- `components/ui/card.tsx` - 노트 컨테이너

### UX/UI 고려사항

- **실시간 피드백:** 자동 저장 상태를 명확하게 표시
- **편집 경험:** 제목과 본문을 자연스럽게 편집할 수 있는 인터페이스
- **에러 처리:** 네트워크 오류나 권한 오류를 사용자 친화적으로 표시
- **모바일 최적화:** 터치 기반 편집에 최적화된 UI

### Testing

#### 테스트 표준

[Source: docs/architecture.md#6-배포운영]

- 테스트 프레임워크: Jest + React Testing Library
- 테스트 파일 위치: `__tests__/` 또는 컴포넌트 옆에 `.test.tsx`

#### 노트 상세 조회/수정 테스트

- 노트 상세 조회 렌더링 테스트
- 실시간 편집 기능 테스트
- 자동 저장 기능 테스트 (디바운스 타이머)
- 저장 상태 UI 표시 테스트
- 에러 핸들링 테스트 (404, 403, 네트워크 오류)
- 권한 검증 테스트
- 반응형 디자인 테스트

## Change Log

| Date       | Version | Description | Author           |
| ---------- | ------- | ----------- | ---------------- |
| 2025-01-15 | 1.0     | 스토리 생성 | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4

### Debug Log References

- 노트 상세 조회 API 구현 완료 (getNoteById 함수)
- 노트 수정 API 구현 완료 (updateNote 함수)
- 자동 저장 기능 구현 완료 (3초 디바운스 타이머)
- 노트 편집기 컴포넌트 구현 완료 (실시간 편집 + 자동 저장)
- 에러 페이지 컴포넌트 구현 완료 (404, 403, 일반 에러 처리)
- 노트 상세 페이지 업데이트 완료 (편집 기능 통합)

### Completion Notes List

- ✅ 노트 상세 조회 API 구현 완료 (사용자 권한 검증 포함)
- ✅ 노트 수정 API 구현 완료 (자동 저장용, updated_at 자동 업데이트)
- ✅ 자동 저장 기능 구현 완료 (3초 디바운스, 재시도 로직 포함)
- ✅ 자동 저장 상태 표시 UI 구현 완료 (저장 중, 완료, 실패 상태)
- ✅ 노트 편집기 컴포넌트 구현 완료 (제목/본문 실시간 편집)
- ✅ 에러 페이지 컴포넌트 구현 완료 (404, 403, 일반 에러 처리)
- ✅ 노트 상세 페이지 업데이트 완료 (편집 기능 통합)
- ✅ 반응형 디자인 적용 완료 (모바일, 태블릿, 데스크톱 최적화)

### File List

**새로 생성된 파일:**
- `components/notes/note-editor.tsx` - 노트 편집기 컴포넌트 (실시간 편집 + 자동 저장)
- `components/notes/auto-save-indicator.tsx` - 자동 저장 상태 표시 컴포넌트
- `components/notes/error-pages.tsx` - 404/403 에러 페이지 컴포넌트

**수정된 파일:**
- `lib/notes/actions.ts` - 노트 상세 조회 및 수정 Server Actions 추가 (getNoteById, updateNote)
- `app/notes/[id]/page.tsx` - 노트 상세 페이지 업데이트 (편집 기능 통합)

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
