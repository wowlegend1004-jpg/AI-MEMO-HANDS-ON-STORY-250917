# Story 4.4: AI 처리 상태 표시 (로딩, 완료, 에러)

## Status

Ready for Review

## Story

**As a** 사용자,
**I want** AI 요약 및 태그 생성 과정에서 실시간으로 처리 상태(로딩, 완료, 에러)를 명확하게 확인할 수 있는 기능,
**so that** AI 작업의 진행 상황을 파악하고 적절한 조치를 취할 수 있다.

## Acceptance Criteria

1. AI 요약 생성 시 로딩 상태가 시각적으로 표시되어야 한다
2. AI 태그 생성 시 로딩 상태가 시각적으로 표시되어야 한다
3. 로딩 상태에는 진행률 표시기(프로그레스 바 또는 스피너)가 포함되어야 한다
4. AI 처리 완료 시 성공 상태가 명확하게 표시되어야 한다
5. AI 처리 실패 시 구체적인 에러 메시지가 표시되어야 한다
6. 에러 발생 시 재시도 옵션이 제공되어야 한다
7. 타임아웃 발생 시 적절한 안내 메시지가 표시되어야 한다
8. 로딩 상태는 최대 10초까지만 표시되어야 한다
9. 동시에 여러 AI 작업이 진행될 때 각각의 상태를 구분해서 표시해야 한다
10. AI 처리 중에는 관련 버튼들이 비활성화되어야 한다
11. 상태 표시는 접근성을 고려한 디자인이어야 한다
12. 모바일 환경에서도 상태 표시가 명확하게 보여야 한다

## Tasks / Subtasks

- [x] AI 처리 상태 관리 시스템 구현 (AC: 1, 2, 9, 10)
  - [x] AI 작업 상태 타입 정의 (로딩, 완료, 에러, 타임아웃)
  - [x] 상태 관리 훅 구현 (useAIStatus)
  - [x] 동시 작업 상태 추적 로직 구현
  - [x] 상태별 버튼 비활성화 로직 구현
- [x] 로딩 상태 UI 컴포넌트 구현 (AC: 3, 8, 11, 12)
  - [x] 프로그레스 바 컴포넌트 구현
  - [x] 스피너 로딩 컴포넌트 구현
  - [x] 로딩 상태 오버레이 컴포넌트 구현
  - [x] 접근성을 고려한 로딩 상태 표시
  - [x] 모바일 반응형 로딩 UI 구현
- [x] 성공 상태 표시 구현 (AC: 4)
  - [x] 성공 애니메이션 컴포넌트 구현
  - [x] 성공 메시지 표시 로직 구현
  - [x] 성공 상태 자동 숨김 기능 구현
- [x] 에러 상태 처리 구현 (AC: 5, 6, 7)
  - [x] 에러 메시지 표시 컴포넌트 구현
  - [x] 재시도 버튼 컴포넌트 구현
  - [x] 타임아웃 에러 처리 로직 구현
  - [x] 에러 상태별 구체적인 메시지 정의
- [x] AI 액션에 상태 통합 (AC: 1, 2, 8)
  - [x] 요약 생성 액션에 상태 관리 통합
  - [x] 태그 생성 액션에 상태 관리 통합
  - [x] 타임아웃 처리 로직 통합
  - [x] 상태 업데이트 로직 통합
- [x] 테스트 구현
  - [x] 상태 관리 훅 단위 테스트
  - [x] 로딩 컴포넌트 테스트
  - [x] 에러 처리 컴포넌트 테스트
  - [x] AI 액션 상태 통합 테스트
  - [x] 접근성 테스트

## Dev Notes

### 이전 스토리 인사이트

[Source: docs/stories/4.3.story.md#completion-notes-list]

- ✅ AI 요약 및 태그 생성 서버 액션이 완전히 구현되어 있음
- ✅ Gemini API 클라이언트와 에러 처리가 완성되어 있음
- ✅ 데이터베이스 스키마와 마이그레이션 시스템이 구축됨
- ✅ shadcn/ui 기반 UI 컴포넌트 구조가 마련됨
- ✅ 서버 액션을 통한 안전한 API 호출 구조가 완성됨
- ✅ 타임아웃 처리 및 에러 핸들링 로직이 구현됨

### 데이터 모델

[Source: docs/architecture.md#2-데이터-모델]

**AI 처리 상태를 위한 추가 타입 정의:**
```typescript
// lib/ai/types.ts
export type AIProcessStatus = 'idle' | 'loading' | 'success' | 'error' | 'timeout';

export interface AIProcessState {
  status: AIProcessStatus;
  progress?: number; // 0-100
  message?: string;
  error?: string;
  retryCount?: number;
  maxRetries?: number;
}

export interface AIJob {
  id: string;
  type: 'summary' | 'tags';
  noteId: string;
  status: AIProcessStatus;
  startTime: number;
  timeout?: number;
}
```

### API 명세

[Source: docs/architecture.md#4-서버-액션]

**상태 관리가 통합된 AI 액션:**
```typescript
// lib/ai/actions.ts
export async function generateSummaryWithStatus(
  noteId: string,
  onStatusUpdate: (status: AIProcessState) => void
): Promise<SummaryResult> {
  // 1. 로딩 상태 시작
  // 2. 요약 생성 진행
  // 3. 상태 업데이트 콜백 호출
  // 4. 완료/에러 상태 처리
}

export async function generateTagsWithStatus(
  noteId: string,
  onStatusUpdate: (status: AIProcessState) => void
): Promise<TagResult> {
  // 1. 로딩 상태 시작
  // 2. 태그 생성 진행
  // 3. 상태 업데이트 콜백 호출
  // 4. 완료/에러 상태 처리
}
```

### 컴포넌트 명세

[Source: docs/architecture.md#1-기술-스택]

**상태 표시 컴포넌트들:**
```typescript
// components/ai/ai-status-indicator.tsx
interface AIStatusIndicatorProps {
  status: AIProcessStatus;
  progress?: number;
  message?: string;
  onRetry?: () => void;
  className?: string;
}

// components/ai/loading-overlay.tsx
interface LoadingOverlayProps {
  isVisible: boolean;
  progress?: number;
  message?: string;
  timeout?: number;
}

// components/ai/error-display.tsx
interface ErrorDisplayProps {
  error: string;
  onRetry?: () => void;
  retryCount?: number;
  maxRetries?: number;
}
```

### 파일 위치

[Source: docs/architecture.md#1-기술-스택]

**새로 생성될 파일:**
- `lib/ai/status-manager.ts` - AI 상태 관리 로직
- `hooks/use-ai-status.ts` - AI 상태 관리 훅
- `components/ai/ai-status-indicator.tsx` - 상태 표시 컴포넌트
- `components/ai/loading-overlay.tsx` - 로딩 오버레이 컴포넌트
- `components/ai/error-display.tsx` - 에러 표시 컴포넌트
- `components/ai/progress-bar.tsx` - 프로그레스 바 컴포넌트
- `__tests__/hooks/use-ai-status.test.ts` - 상태 관리 훅 테스트
- `__tests__/components/ai/ai-status-indicator.test.tsx` - 상태 표시 컴포넌트 테스트

**수정될 파일:**
- `lib/ai/actions.ts` - 상태 관리 통합
- `lib/ai/types.ts` - 상태 관련 타입 추가
- `components/notes/summary-generator.tsx` - 상태 표시 통합
- `components/notes/tag-generator.tsx` - 상태 표시 통합
- `app/notes/[id]/page.tsx` - 상태 표시 UI 통합

### 기술적 제약사항

[Source: docs/architecture.md#6-배포운영]

- **타임아웃:** 최대 10초 (Gemini API 응답 시간 고려)
- **재시도:** 최대 3회까지 자동 재시도
- **상태 지속성:** 메모리 기반 (페이지 새로고침 시 초기화)
- **동시 작업:** 최대 2개까지 동시 AI 작업 허용
- **접근성:** WCAG 2.1 AA 수준 준수

### 보안 고려사항

[Source: docs/architecture.md#3-보안]

- **상태 격리:** 사용자별 AI 작업 상태 격리
- **에러 정보:** 민감한 정보가 포함되지 않은 에러 메시지만 표시
- **재시도 제한:** 무한 재시도 방지를 위한 최대 재시도 횟수 제한

### 성능 최적화

[Source: docs/architecture.md#6-배포운영]

- **상태 업데이트:** 디바운싱을 통한 과도한 상태 업데이트 방지
- **메모리 관리:** 완료된 작업 상태 자동 정리
- **렌더링 최적화:** React.memo를 통한 불필요한 리렌더링 방지
- **애니메이션:** CSS 트랜지션을 활용한 부드러운 상태 전환

### 테스트 요구사항

[Source: docs/architecture.md#1-기술-스택]

**단위 테스트:**
- AI 상태 관리 훅 테스트
- 상태 표시 컴포넌트 테스트
- 에러 처리 로직 테스트
- 타임아웃 처리 테스트

**통합 테스트:**
- AI 액션과 상태 관리 통합 테스트
- 동시 작업 상태 관리 테스트
- 사용자 상호작용 테스트
- 접근성 테스트

**E2E 테스트:**
- 전체 AI 처리 플로우 테스트
- 에러 시나리오 테스트
- 모바일 환경 테스트

## Change Log

| Date       | Version | Description                | Author                    |
| ---------- | ------- | -------------------------- | ------------------------- |
| 2025-01-15 | 1.0     | 스토리 4.4 초안 생성       | Scrum Master Bob          |
| 2025-01-15 | 1.1     | 스토리 4.4 구현 완료       | Dev Agent Claude 4 Sonnet |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4

### Debug Log References

- AI 상태 관리 시스템 구현 및 통합
- UI 컴포넌트 개발 및 접근성 고려
- 기존 AI 액션과 상태 관리 통합
- 테스트 코드 작성 및 검증

### Completion Notes List

- ✅ AI 처리 상태 타입 정의 완료 (AIProcessStatus, AIProcessState, AIJob)
- ✅ AI 상태 관리자 클래스 구현 완료 (AIStatusManager)
- ✅ React 훅 구현 완료 (useAIStatus, useMultipleAIStatus)
- ✅ 프로그레스 바 컴포넌트 구현 완료 (ProgressBar, SpinnerProgress, StepProgress)
- ✅ 로딩 오버레이 컴포넌트 구현 완료 (LoadingOverlay, InlineLoading, CompactLoading)
- ✅ AI 상태 표시 컴포넌트 구현 완료 (AIStatusIndicator, 상태별 전용 컴포넌트들)
- ✅ 에러 표시 컴포넌트 구현 완료 (ErrorDisplay, SuccessDisplay)
- ✅ AI 액션에 상태 관리 통합 완료 (generateSummaryWithStatus, generateTagsWithStatus)
- ✅ 기존 컴포넌트 업데이트 완료 (SummaryGenerator, TagGenerator)
- ✅ 포괄적인 테스트 코드 작성 완료 (훅, 컴포넌트, 접근성 테스트)

### File List

**새로 생성된 파일:**
- `lib/ai/status-manager.ts` - AI 상태 관리 로직
- `hooks/use-ai-status.ts` - AI 상태 관리 React 훅
- `components/ai/progress-bar.tsx` - 프로그레스 바 컴포넌트
- `components/ai/loading-overlay.tsx` - 로딩 오버레이 컴포넌트
- `components/ai/ai-status-indicator.tsx` - AI 상태 표시 컴포넌트
- `components/ai/error-display.tsx` - 에러 표시 컴포넌트
- `__tests__/hooks/use-ai-status.test.ts` - 상태 관리 훅 테스트
- `__tests__/components/ai/ai-status-indicator.test.tsx` - 상태 표시 컴포넌트 테스트
- `__tests__/components/ai/progress-bar.test.tsx` - 프로그레스 바 컴포넌트 테스트
- `__tests__/components/ai/error-display.test.tsx` - 에러 표시 컴포넌트 테스트

**수정된 파일:**
- `lib/ai/types.ts` - AI 상태 관련 타입 추가
- `lib/ai/actions.ts` - 상태 관리가 통합된 AI 액션 추가
- `components/notes/summary-generator.tsx` - 상태 표시 통합
- `components/notes/tag-generator.tsx` - 상태 표시 통합
