# Story 4.1: Gemini API 설정 및 연동

## Status

Ready for Review

## Story

**As a** 개발자,
**I want** Google Gemini API를 프로젝트에 안전하게 연동하고 기본 설정을 완료하는 기능,
**so that** 노트에 대한 AI 기반 요약 및 태깅 서비스를 제공할 수 있다.

## Acceptance Criteria

1. Google Gemini API 키가 환경변수로 안전하게 관리되어야 한다
2. Gemini API 클라이언트가 Next.js 서버 환경에서 정상 작동해야 한다
3. API 연결 상태를 확인할 수 있는 헬스체크 기능이 있어야 한다
4. API 호출 시 적절한 에러 핸들링이 구현되어야 한다
5. 토큰 사용량을 추적할 수 있는 기본 구조가 마련되어야 한다
6. API 응답 시간이 10초를 초과하면 타임아웃 처리되어야 한다
7. 개발/스테이징/프로덕션 환경별로 다른 설정이 가능해야 한다
8. API 사용량 제한에 대한 기본 정책이 설정되어야 한다
9. Gemini API 응답 형식에 대한 타입 정의가 있어야 한다
10. 기본적인 텍스트 생성 테스트가 성공해야 한다

## Tasks / Subtasks

-   [x] Gemini API 라이브러리 설치 및 설정 (AC: 1, 2, 7)
    -   [x] @google/genai 패키지 설치
    -   [x] 환경변수 설정 (.env.local, .env.example)
    -   [x] API 클라이언트 초기화 함수 구현
    -   [x] 환경별 설정 분리
-   [x] API 연동 기본 구조 구현 (AC: 3, 4, 6)
    -   [x] Gemini 클라이언트 래퍼 클래스 구현
    -   [x] 헬스체크 함수 구현
    -   [x] 에러 핸들링 및 재시도 로직
    -   [x] 타임아웃 설정 및 처리
-   [x] 타입 정의 및 인터페이스 (AC: 9, 10)
    -   [x] Gemini API 요청/응답 타입 정의
    -   [x] AI 서비스 공통 인터페이스 설계
    -   [x] 에러 타입 정의
    -   [x] 기본 텍스트 생성 테스트 함수
-   [x] 사용량 모니터링 기반 구조 (AC: 5, 8)
    -   [x] 토큰 사용량 계산 유틸리티
    -   [x] API 호출 로깅 시스템
    -   [x] 사용량 제한 정책 설정
    -   [x] 비용 추적 기본 구조

## Dev Notes

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

-   **프레임워크:** Next.js (App Router, Server Actions)
-   **AI API:** Google Gemini API (@google/genai)
-   **환경 관리:** dotenv, Next.js 환경변수
-   **타입스크립트:** 완전한 타입 안전성

### Google Gemini API 설정

**필요한 패키지:**

```bash
pnpm install @google/genai
pnpm add -D jest @jest/globals ts-jest
```

**환경변수 설정:**

```env
# .env.local
GEMINI_API_KEY=your_api_key_here
GEMINI_MODEL=gemini-2.0-flash-001
GEMINI_MAX_TOKENS=8192
GEMINI_TIMEOUT_MS=10000

# Optional: 환경별 설정
NODE_ENV=development
GEMINI_DEBUG=true
```

### API 클라이언트 구조

**기본 클라이언트 설정:**

```typescript
// lib/ai/gemini-client.ts
import { GoogleGenAI } from '@google/genai'

export class GeminiClient {
    private client: GoogleGenAI
    private model: string
    private maxTokens: number
    private timeout: number

    constructor() {
        this.client = new GoogleGenAI({
            apiKey: process.env.GEMINI_API_KEY!
        })
        this.model = process.env.GEMINI_MODEL || 'gemini-2.0-flash-001'
        this.maxTokens = parseInt(process.env.GEMINI_MAX_TOKENS || '8192')
        this.timeout = parseInt(process.env.GEMINI_TIMEOUT_MS || '10000')
    }

    async healthCheck(): Promise<boolean> {
        try {
            const result = await this.generateText('Hello')
            return !!result
        } catch (error) {
            console.error('Gemini health check failed:', error)
            return false
        }
    }

    async generateText(prompt: string): Promise<string> {
        try {
            const response = await this.client.models.generateContent({
                model: this.model,
                contents: prompt
            })
            return response.text
        } catch (error) {
            throw this.handleError(error)
        }
    }

    private handleError(error: any): Error {
        // 에러 처리 로직 구현 예정
        return new Error(`Gemini API Error: ${error.message}`)
    }
}
```

### 에러 처리 전략

**에러 타입 정의:**

```typescript
export enum GeminiErrorType {
    API_KEY_INVALID = 'API_KEY_INVALID',
    QUOTA_EXCEEDED = 'QUOTA_EXCEEDED',
    TIMEOUT = 'TIMEOUT',
    CONTENT_FILTERED = 'CONTENT_FILTERED',
    NETWORK_ERROR = 'NETWORK_ERROR',
    UNKNOWN = 'UNKNOWN'
}

export class GeminiError extends Error {
    constructor(
        public type: GeminiErrorType,
        message: string,
        public originalError?: any
    ) {
        super(message)
        this.name = 'GeminiError'
    }
}
```

**재시도 로직:**

```typescript
async function withRetry<T>(
    operation: () => Promise<T>,
    maxRetries: number = 3,
    backoffMs: number = 1000
): Promise<T> {
    let lastError: Error

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            return await operation()
        } catch (error) {
            lastError = error as Error

            // 재시도 불가능한 에러는 즉시 throw
            if (isNonRetryableError(error)) {
                throw error
            }

            if (attempt < maxRetries) {
                await sleep(backoffMs * attempt)
            }
        }
    }

    throw lastError!
}
```

### 토큰 사용량 관리

**토큰 계산 유틸리티:**

```typescript
export function estimateTokens(text: string): number {
    // 대략적인 토큰 수 계산 (1 토큰 ≈ 4 문자)
    return Math.ceil(text.length / 4)
}

export function validateTokenLimit(
    inputTokens: number,
    maxTokens: number = 8192
): boolean {
    // 응답용 토큰도 고려하여 여유분 확보
    const reservedTokens = 2000
    return inputTokens <= maxTokens - reservedTokens
}
```

**사용량 로깅:**

```typescript
interface APIUsageLog {
    timestamp: Date
    model: string
    inputTokens: number
    outputTokens: number
    latencyMs: number
    success: boolean
    error?: string
}

export function logAPIUsage(log: APIUsageLog): void {
    // 개발 환경에서는 콘솔 출력
    if (process.env.NODE_ENV === 'development') {
        console.log('[Gemini API Usage]', log)
    }

    // 프로덕션에서는 실제 로깅 시스템으로 전송
    // TODO: 로깅 시스템 연동
}
```

### 설정 관리

**환경별 설정:**

```typescript
interface GeminiConfig {
    apiKey: string
    model: string
    maxTokens: number
    timeout: number
    debug: boolean
    rateLimitPerMinute: number
}

export function getGeminiConfig(): GeminiConfig {
    const config: GeminiConfig = {
        apiKey: process.env.GEMINI_API_KEY!,
        model: process.env.GEMINI_MODEL || 'gemini-2.0-flash-001',
        maxTokens: parseInt(process.env.GEMINI_MAX_TOKENS || '8192'),
        timeout: parseInt(process.env.GEMINI_TIMEOUT_MS || '10000'),
        debug: process.env.GEMINI_DEBUG === 'true',
        rateLimitPerMinute: parseInt(process.env.GEMINI_RATE_LIMIT || '60')
    }

    // 필수 설정 검증
    if (!config.apiKey) {
        throw new Error('GEMINI_API_KEY is required')
    }

    return config
}
```

### 보안 고려사항

**API 키 보안:**

-   환경변수를 통한 안전한 키 관리
-   .env 파일을 .gitignore에 추가
-   프로덕션에서는 시크릿 관리 서비스 사용
-   API 키 로테이션 정책 수립

**데이터 보안:**

-   사용자 노트 내용의 익명화 처리
-   API 호출 로그에서 민감정보 제거
-   HTTPS 통신 강제
-   에러 메시지에서 시스템 정보 노출 방지

### 성능 최적화

**요청 최적화:**

-   배치 처리로 API 호출 횟수 감소
-   캐싱을 통한 중복 요청 방지
-   토큰 수 사전 체크로 불필요한 호출 방지
-   Connection pooling 활용

**응답 시간 관리:**

-   적절한 타임아웃 설정
-   스트리밍 응답 활용 (가능한 경우)
-   로딩 상태 표시로 사용자 경험 개선

### 테스트 전략

**단위 테스트:**

```typescript
describe('GeminiClient', () => {
    test('should initialize with correct config', () => {
        const client = new GeminiClient()
        expect(client).toBeDefined()
    })

    test('should handle API errors gracefully', async () => {
        // Mock API error response
        // Test error handling
    })

    test('should respect token limits', () => {
        const longText = 'a'.repeat(50000)
        expect(() => validateTokenLimit(estimateTokens(longText))).toThrow()
    })
})
```

**통합 테스트:**

```typescript
describe('Gemini API Integration', () => {
    test('should successfully generate text', async () => {
        const client = new GeminiClient()
        const result = await client.generateText('Hello, world!')
        expect(result).toBeTruthy()
        expect(typeof result).toBe('string')
    })

    test('should handle timeout properly', async () => {
        // Test with very short timeout
    })
})
```

### 모니터링 및 알림

**메트릭 수집:**

-   API 응답 시간
-   성공/실패 비율
-   토큰 사용량
-   에러 발생 빈도

**알림 설정:**

-   API 호출 실패율 임계값 초과 시
-   토큰 사용량 급증 시
-   응답 시간 지연 시

### 프로젝트 구조

**새로 추가될 파일:**

-   `lib/ai/gemini-client.ts` - Gemini API 클라이언트
-   `lib/ai/types.ts` - AI 관련 타입 정의
-   `lib/ai/utils.ts` - AI 유틸리티 함수
-   `lib/ai/config.ts` - AI 설정 관리
-   `lib/ai/errors.ts` - AI 에러 정의
-   `__tests__/ai/gemini-client.test.ts` - 클라이언트 테스트

**환경 설정 파일:**

-   `.env.example` - 환경변수 예시
-   `next.config.ts` - Next.js 설정 업데이트

## Change Log

| Date       | Version | Description                                | Author                    |
| ---------- | ------- | ------------------------------------------ | ------------------------- |
| 2025-09-14 | 1.0     | 스토리 생성                                | Dev Agent Claude 4 Sonnet |
| 2025-09-14 | 1.1     | 정확한 패키지명 및 API 사용법으로 업데이트 | Dev Agent Claude 4 Sonnet |
| 2025-09-17 | 1.2     | 스토리 4.1 구현 완료 - Gemini API 연동    | Dev Agent Claude 4 Sonnet |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4

### Debug Log References

- Gemini API 클라이언트 초기화 및 설정 검증
- 환경변수 로딩 및 검증 로그
- API 호출 시 사용량 및 에러 로깅
- 헬스체크 및 연결 상태 확인

### Completion Notes List

- ✅ @google/genai 패키지 설치 완료 (v1.20.0)
- ✅ 환경변수 설정 완료 (.env.local, .env.example 업데이트)
- ✅ 완전한 타입 안전성을 위한 TypeScript 타입 정의 구현
- ✅ 에러 처리 및 재시도 로직 구현
- ✅ 토큰 사용량 추적 및 모니터링 시스템 구현
- ✅ 서버 액션을 통한 안전한 API 호출 구조 구현
- ✅ 테스트 페이지 (/test-ai) 구현으로 실제 API 연동 확인 가능
- ✅ 환경별 설정 분리 (개발/스테이징/프로덕션)
- ✅ 사용량 통계 및 헬스체크 기능 구현

### File List

**새로 생성된 파일:**
- `lib/ai/types.ts` - AI 서비스 타입 정의
- `lib/ai/errors.ts` - 에러 처리 및 분류
- `lib/ai/config.ts` - 환경별 설정 관리
- `lib/ai/utils.ts` - 유틸리티 함수 (토큰 계산, 재시도 등)
- `lib/ai/gemini-client.ts` - 메인 Gemini API 클라이언트
- `lib/ai/actions.ts` - 서버 액션 함수들
- `app/test-ai/page.tsx` - AI 서비스 테스트 페이지
- `components/ai/test-ai-form.tsx` - AI 테스트 폼 컴포넌트
- `__tests__/ai/gemini-client.test.ts` - 클라이언트 테스트
- `__tests__/ai/actions.test.ts` - 서버 액션 테스트

**수정된 파일:**
- `.env.example` - Gemini API 환경변수 추가
- `package.json` - @google/genai 의존성 추가

## QA Results

QA 에이전트가 완료된 스토리 구현을 검토한 결과입니다.
